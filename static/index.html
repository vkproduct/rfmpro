<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>RFM Анализатор</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <h1>RFM Анализатор</h1>
        <div id="auth" class="card">
            <h2>Регистрация</h2>
            <input id="reg_email" placeholder="Email">
            <input id="reg_password" type="password" placeholder="Пароль">
            <button onclick="register()">Зарегистрироваться</button>
            
            <h2>Вход</h2>
            <input id="login_email" placeholder="Email">
            <input id="login_password" type="password" placeholder="Пароль">
            <button onclick="login()">Войти</button>
        </div>
        <div id="upload" class="card" style="display: none;">
            <h2>Загрузка данных</h2>
            <form id="uploadForm" enctype="multipart/form-data">
                <input type="file" id="csvFile" name="file" accept=".csv" onchange="loadColumns()">
                <select id="customer_col" name="customer_col">
                    <option value="">Выберите колонку клиента</option>
                </select>
                <select id="date_col" name="date_col">
                    <option value="">Выберите колонку даты</option>
                </select>
                <select id="amount_col" name="amount_col">
                    <option value="">Выберите колонку суммы</option>
                </select>
                <button type="button" onclick="upload()">Анализировать</button>
            </form>
            <pre id="result"></pre>
        </div>
    </div>
    <script>
        let authToken = null;
        function register() {
            const email = document.getElementById('reg_email').value;
            const password = document.getElementById('reg_password').value;
            fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `email=${email}&password=${password}`
            })
            .then(response => response.json())
            .then(data => alert(data.message));
        }

        function login() {
            const email = document.getElementById('login_email').value;
            const password = document.getElementById('login_password').value;
            fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `email=${email}&password=${password}`
            })
            .then(response => {
                authToken = response.headers.get('X-Auth-Token');
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('auth').style.display = 'none';
                    document.getElementById('upload').style.display = 'block';
                } else {
                    alert(data.message);
                }
            });
        }

        function loadColumns() {
            const file = document.getElementById('csvFile').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result.split('\n')[0];
                const columns = text.split(',');
                const selects = ['customer_col', 'date_col', 'amount_col'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">Выберите колонку</option>';
                    columns.forEach(col => {
                        const option = document.createElement('option');
                        option.value = col.trim();
                        option.text = col.trim();
                        select.appendChild(option);
                    });
                });
            };
            reader.readAsText(file);
        }

        function upload() {
            const file = document.getElementById('csvFile').files[0];
            const customer_col = document.getElementById('customer_col').value;
            const date_col = document.getElementById('date_col').value;
            const amount_col = document.getElementById('amount_col').value;
            const formData = new FormData();
            formData.append('file', file);
            formData.append('customer_col', customer_col);
            formData.append('date_col', date_col);
            formData.append('amount_col', amount_col);
            
            fetch('/upload', {
                method: 'POST',
                headers: { 'Authorization': `Basic ${authToken}` },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('result').textContent = JSON.stringify(data, null, 2);
            })
            .catch(error => alert('Ошибка: ' + error));
        }
    </script>
</body>
</html>